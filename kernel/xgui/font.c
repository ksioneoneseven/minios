/*
 * MiniOS XGUI Font Rendering
 *
 * 8x16 bitmap font for text rendering on framebuffer.
 * Based on standard VGA/BIOS font.
 */

#include "../include/xgui/font.h"
#include "../include/vesa.h"
#include "../include/string.h"

/*
 * 8x16 bitmap font data for ASCII characters 32-127
 * Each character is 16 bytes (8 pixels wide, 16 rows tall)
 * Each byte represents one row, MSB = leftmost pixel
 */
static const uint8_t font_8x16[96][16] = {
    /* 32 ' ' (space) */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 33 '!' */
    { 0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
      0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* 34 '"' */
    { 0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 35 '#' */
    { 0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C,
      0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* 36 '$' */
    { 0x18, 0x18, 0x7C, 0xC6, 0xC2, 0xC0, 0x7C, 0x06,
      0x06, 0x86, 0xC6, 0x7C, 0x18, 0x18, 0x00, 0x00 },
    /* 37 '%' */
    { 0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18,
      0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00 },
    /* 38 '&' */
    { 0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* 39 '\'' */
    { 0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 40 '(' */
    { 0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00 },
    /* 41 ')' */
    { 0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C,
      0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* 42 '*' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF,
      0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 43 '+' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E,
      0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 44 ',' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00 },
    /* 45 '-' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 46 '.' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* 47 '/' */
    { 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18,
      0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00 },
    /* 48 '0' */
    { 0x00, 0x00, 0x38, 0x6C, 0xC6, 0xC6, 0xD6, 0xD6,
      0xC6, 0xC6, 0x6C, 0x38, 0x00, 0x00, 0x00, 0x00 },
    /* 49 '1' */
    { 0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00 },
    /* 50 '2' */
    { 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30,
      0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 51 '3' */
    { 0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06,
      0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 52 '4' */
    { 0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE,
      0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00 },
    /* 53 '5' */
    { 0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06,
      0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 54 '6' */
    { 0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 55 '7' */
    { 0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18,
      0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* 56 '8' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 57 '9' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06,
      0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00 },
    /* 58 ':' */
    { 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 59 ';' */
    { 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
      0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00 },
    /* 60 '<' */
    { 0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
      0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00 },
    /* 61 '=' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
      0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 62 '>' */
    { 0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
      0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00 },
    /* 63 '?' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18,
      0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* 64 '@' */
    { 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE,
      0xDE, 0xDC, 0xC0, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 65 'A' */
    { 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 66 'B' */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66,
      0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00 },
    /* 67 'C' */
    { 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0,
      0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 68 'D' */
    { 0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66,
      0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00 },
    /* 69 'E' */
    { 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
      0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 70 'F' */
    { 0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* 71 'G' */
    { 0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE,
      0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00 },
    /* 72 'H' */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 73 'I' */
    { 0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 74 'J' */
    { 0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
      0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00 },
    /* 75 'K' */
    { 0x00, 0x00, 0xE6, 0x66, 0x66, 0x6C, 0x78, 0x78,
      0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* 76 'L' */
    { 0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60,
      0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 77 'M' */
    { 0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 78 'N' */
    { 0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE,
      0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 79 'O' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 80 'P' */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* 81 'Q' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00 },
    /* 82 'R' */
    { 0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C,
      0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* 83 'S' */
    { 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C,
      0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 84 'T' */
    { 0x00, 0x00, 0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 85 'U' */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 86 'V' */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
      0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00 },
    /* 87 'W' */
    { 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6,
      0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* 88 'X' */
    { 0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38,
      0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 89 'Y' */
    { 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 90 'Z' */
    { 0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30,
      0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 91 '[' */
    { 0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 92 '\' */
    { 0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18,
      0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 93 ']' */
    { 0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
      0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 94 '^' */
    { 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 95 '_' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00 },
    /* 96 '`' */
    { 0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 97 'a' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* 98 'b' */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66,
      0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 99 'c' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0,
      0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 100 'd' */
    { 0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* 101 'e' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE,
      0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 102 'f' */
    { 0x00, 0x00, 0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* 103 'g' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00 },
    /* 104 'h' */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66,
      0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* 105 'i' */
    { 0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 106 'j' */
    { 0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
      0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00 },
    /* 107 'k' */
    { 0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78,
      0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00 },
    /* 108 'l' */
    { 0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
      0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00 },
    /* 109 'm' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6,
      0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 110 'n' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
      0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00 },
    /* 111 'o' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 112 'p' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
      0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00 },
    /* 113 'q' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00 },
    /* 114 'r' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66,
      0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00 },
    /* 115 's' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60,
      0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00 },
    /* 116 't' */
    { 0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30,
      0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00 },
    /* 117 'u' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC,
      0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00 },
    /* 118 'v' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66,
      0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* 119 'w' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6,
      0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00 },
    /* 120 'x' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38,
      0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00 },
    /* 121 'y' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
      0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00 },
    /* 122 'z' */
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18,
      0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00 },
    /* 123 '{' */
    { 0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
      0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00 },
    /* 124 '|' */
    { 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
      0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00 },
    /* 125 '}' */
    { 0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
      0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00 },
    /* 126 '~' */
    { 0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    /* 127 DEL (filled box) */
    { 0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6,
      0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }
};

/*
 * Get font bitmap for a character
 */
const uint8_t* xgui_font_get_glyph(char c) {
    unsigned char uc = (unsigned char)c;
    if (uc < 32 || uc > 127) {
        uc = '?';  /* Replace unprintable characters */
    }
    return font_8x16[uc - 32];
}

/*
 * Draw a single character at (x, y)
 */
void xgui_font_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg) {
    const uint8_t* glyph = xgui_font_get_glyph(c);

    for (int row = 0; row < XGUI_FONT_HEIGHT; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < XGUI_FONT_WIDTH; col++) {
            uint32_t color = (bits & 0x80) ? fg : bg;
            vesa_set_pixel(x + col, y + row, color);
            bits <<= 1;
        }
    }
}

/*
 * Draw a string at (x, y) with background
 */
void xgui_font_draw_string(int x, int y, const char* str, uint32_t fg, uint32_t bg) {
    int start_x = x;

    while (*str) {
        if (*str == '\n') {
            x = start_x;
            y += XGUI_FONT_HEIGHT;
        } else if (*str == '\t') {
            x += XGUI_FONT_WIDTH * 4;  /* Tab = 4 spaces */
        } else {
            xgui_font_draw_char(x, y, *str, fg, bg);
            x += XGUI_FONT_WIDTH;
        }
        str++;
    }
}

/*
 * Draw a string with transparent background
 */
void xgui_font_draw_string_transparent(int x, int y, const char* str, uint32_t fg) {
    int start_x = x;

    while (*str) {
        if (*str == '\n') {
            x = start_x;
            y += XGUI_FONT_HEIGHT;
        } else if (*str == '\t') {
            x += XGUI_FONT_WIDTH * 4;
        } else {
            const uint8_t* glyph = xgui_font_get_glyph(*str);
            for (int row = 0; row < XGUI_FONT_HEIGHT; row++) {
                uint8_t bits = glyph[row];
                for (int col = 0; col < XGUI_FONT_WIDTH; col++) {
                    if (bits & 0x80) {
                        vesa_set_pixel(x + col, y + row, fg);
                    }
                    bits <<= 1;
                }
            }
            x += XGUI_FONT_WIDTH;
        }
        str++;
    }
}

/*
 * Calculate pixel width of a string
 */
int xgui_font_string_width(const char* str) {
    int width = 0;
    int max_width = 0;

    while (*str) {
        if (*str == '\n') {
            if (width > max_width) max_width = width;
            width = 0;
        } else if (*str == '\t') {
            width += XGUI_FONT_WIDTH * 4;
        } else {
            width += XGUI_FONT_WIDTH;
        }
        str++;
    }

    return (width > max_width) ? width : max_width;
}

/*
 * Calculate pixel height of a string
 */
int xgui_font_string_height(const char* str) {
    int lines = 1;

    while (*str) {
        if (*str == '\n') {
            lines++;
        }
        str++;
    }

    return lines * XGUI_FONT_HEIGHT;
}
